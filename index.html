<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
</head>
<body>
  <div id="content">
    <canvas id="canvas" width="500" height="400"></canvas>
  </div>
  
<script>
  
let memory;

const readCharStr = (ptr, len) => {
  const bytes = new Uint8Array(memory.buffer, ptr, len);
  return new TextDecoder("utf-8").decode(bytes);
}

const canvas = document.getElementById("canvas");

const gl = canvas.getContext('2d');
gl.scale(2, 2);

fetchAndInstantiate('main_web.wasm', {}).then(function(instance) {
  instance.exports.onInit();
  var memory = instance.exports.memory;


  var imgd = new Uint8ClampedArray(memory.buffer, 0, 64*32*4);
  for (let index = 0; index < imgd.length; index++) {
      imgd[index] = 0;
  }
  const onAnimationFrame = instance.exports.onAnimationFrame;

  function step(timestamp) {
    onAnimationFrame(timestamp);
    if (instance.exports.need_display_update()) {
        instance.exports.get_display_data(imgd.byteOffset);
        var internal_canvas = document.createElement('canvas')
        var internal_context = internal_canvas.getContext("2d");

        var imgData = internal_context.createImageData(64, 32); // width x height
        var data = imgData.data;

        for (var i = 0, len = 64 * 32 * 4; i < len; i++) {
            data[i] = imgd[i];
        }

        // now we can draw our imagedata onto the canvas
        internal_context.putImageData(imgData, 0, 0);
        gl.drawImage(internal_canvas, 0, 0, 64, 32, 0, 0, 64*4, 32*4);
    }
    window.requestAnimationFrame(step);
  }
  window.requestAnimationFrame(step);
});

function fetchAndInstantiate(url, importObject) {
  return fetch(url).then(response =>
    response.arrayBuffer()
  ).then(bytes =>
    WebAssembly.instantiate(bytes, importObject)
  ).then(results =>
    results.instance
  );
}

</script>
</body>
</html>